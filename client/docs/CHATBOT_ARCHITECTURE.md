# מסמך ארכיטקטורה - צ'אטבוט אבחון רכב

## מטרת הצ'אטבוט

הצ'אטבוט מספק **ייעוץ רכב לאנשים ללא ניסיון בטיפול עצמי ברכב**. המטרה היא:
1. **אבחון תקלות** - זיהוי הבעיה על סמך תסמינים ונורות אזהרה
2. **הנחיות לביצוע פעולות** - צעדים בטוחים שהמשתמש יכול לבצע בעצמו
3. **דיאגנוזה סופית** - דו"ח מפורט עם סיבות אפשריות והמלצות

---

## מבנה התיקיות

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📁 lib/ai/                      ← לוגיקה עסקית (Backend Brain)             │
│  📁 lib/knowledge/               ← בסיס ידע סטטי (KB)                       │
│  📁 app/api/ai/questions/        ← API Endpoint                            │
│  📁 app/user/consult/questions/  ← Frontend UI                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Backend - קבצי lib/ai/

### 1. `types.ts` - הגדרות טיפוסים
**תפקיד:** הגדרת כל הטיפוסים המשותפים למערכת

| טיפוס | תיאור |
|-------|-------|
| `UserAnswer` | שאלה + תשובה מהמשתמש |
| `ChatMessage` | הודעה בצ'אט (AI/user/system) |
| `DiagnosisData` | דיאגנוזה סופית + אזהרות |
| `AIState` | מצב הצ'אטבוט (IDLE/ASKING/PROCESSING/FINISHED) |
| `AIQuestion` | שאלה עם סוג (yesno/multi/text/instruction) |

---

### 2. `client.ts` - לקוח OpenAI
**תפקיד:** תקשורת עם OpenAI GPT-4o

**יכולות:**
- ניהול Timeout (30 שניות)
- ניסיונות חוזרים (Retry) עם backoff
- תמיכה בתמונות (multimodal)
- החזרת JSON מובנה

**חיבורים:**
```
client.ts ←── uses ── retry.ts (withRetry, withTimeout)
         ←── uses ── sanitize.ts (sanitizeInput)
```

---

### 3. `context-analyzer.ts` - מנתח הקשר ראשוני
**תפקיד:** ניתוח הטקסט הראשוני של המשתמש וניתוב לזרימה הנכונה

**תהליך הניתוח:**
```
קלט משתמש
    │
    ├──▶ 1. בדיקת בטיחות (SAFETY_STOP)
    │        ↳ "עשן מהמנוע" → עצור מיד!
    │
    ├──▶ 2. מיפוי תסמינים (car-symptoms.json)
    │        ↳ "נורה אדומה" → WARNING_LIGHT
    │        ↳ "רעש במנוע" → START_SCENARIO
    │
    ├──▶ 3. התאמה ישירה (warning-lights.json)
    │        ↳ "נורת שמן" → oil_pressure_light
    │
    └──▶ 4. Fallback → CONSULT_AI
```

**פלט אפשרי:**
- `SAFETY_STOP` - מצב חירום, עצור שיחה
- `WARNING_LIGHT` - זוהתה נורת אזהרה, התחל KB flow
- `START_SCENARIO` - התחל תרחיש סטטי
- `CONSULT_AI` - לא זוהה כלום, שלח ל-AI

---

### 4. `prompt-builder.ts` - בונה Prompts
**תפקיד:** בניית הפרומפטים לשליחה ל-AI

**מצבים (Modes):**
| מצב | תיאור |
|-----|-------|
| `OPTION_MAPPER` | מיפוי תשובה חופשית לאופציה מוגדרת |
| `KB_COORDINATION` | בניית פרומפט עם ידע ספציפי לנורה |
| `BRIDGE_TO_KB` | ניסיון לזהות נורה מתשובות כלליות |
| `EXPERT` | מצב מומחה כללי |

**פונקציות עיקריות:**
- `buildChatPrompt()` - פרומפט לצ'אט
- `buildGeneralExpertPrompt()` - פרומפט מומחה
- `suggestFollowupQuestion()` - שאלות המשך מה-KB

---

### 5. `diagnostic-utils.ts` - כלי אבחון (הקובץ הכי חשוב!)
**תפקיד:** כל הלוגיקה של האבחון

**פונקציות עיקריות:**

| פונקציה | תיאור |
|---------|-------|
| `determineScenario()` | קביעת הסצנריו על סמך תשובות |
| `updateScores()` | עדכון ציוני סיבות (cause scores) |
| `shouldDiagnose()` | החלטה אם יש מספיק מידע לאבחון |
| `getNextQuestion()` | קבלת השאלה הבאה מה-KB |
| `generateDiagnosis()` | יצירת דו"ח אבחון סופי |
| `checkImmediateAction()` | בדיקה אם צריך פעולה מיידית |

**לוגיקת ציונים:**
```
┌─────────────────────────────────────────────────────────────────┐
│  כל סיבה (cause) מתחילה עם ציון 0                              │
│                                                                 │
│  תשובה שמחזקת סיבה:  ציון += כמות (לפי probability)             │
│  תשובה ששוללת סיבה:  ציון -= כמות                               │
│                                                                 │
│  כשציון עובר THRESHOLD (4) + מינימום שאלות (4) → אבחון!         │
└─────────────────────────────────────────────────────────────────┘
```

---

### 6. `flow-handlers.ts` - מנהל זרימות (Brain)
**תפקיד:** הלוגיקה המרכזית שמנהלת את כל הזרימות

**פונקציות עיקריות:**

| פונקציה | תיאור |
|---------|-------|
| `handleKBFlow()` | טיפול בזרימת נורות אזהרה |
| `handleScenarioStep()` | טיפול בתרחישים סטטיים |
| `callExpertAI()` | קריאה ל-AI כ-fallback |
| `handleWarningLightDetection()` | התחלת זרימת נורה |
| `handleScenarioStart()` | התחלת תרחיש |
| `handleSafetyStop()` | עצירת חירום |
| `lookupResolutionPath()` | חיפוש נתיב פתרון ב-KB |
| `handleResolutionPath()` | עיבוד נתיב פתרון |
| `isResolvedOption()` | זיהוי אם המשתמש פתר את הבעיה |

**תהליך handleKBFlow:**
```
┌─────────────────────────────────────────────────────────────────┐
│  1. קביעת/אימות סצנריו (determineScenario)                      │
│  2. בדיקת פעולות מיידיות (checkImmediateAction)                 │
│  3. עדכון ציונים (updateScores)                                 │
│  4. בדיקת resolution_paths אם יש                               │
│  5. האם להמשיך או לאבחן? (shouldDiagnose)                       │
│  6. שאלה הבאה או דיאגנוזה סופית                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

### 7. קבצי עזר נוספים

| קובץ | תפקיד |
|------|-------|
| `retry.ts` | לוגיקת ניסיונות חוזרים ו-timeout |
| `sanitize.ts` | ניקוי קלט מתווים מזיקים |
| `image-utils.ts` | עיבוד תמונות (resize, base64) |

---

## Backend - קבצי lib/knowledge/

### 1. `warning-lights.json` - בסיס הידע הראשי (168KB!)
**תפקיד:** מאגר כל המידע על נורות אזהרה

**מבנה:**
```json
{
  "battery_light": {
    "severity": "critical",
    "names": { "he": ["נורת מצבר"], "en": ["battery light"] },
    "first_question": {
      "text": "מתי הנורה נדלקה?",
      "options": [
        {"id": "while_driving", "label": "נדלקה בזמן נסיעה"},
        {"id": "wont_start", "label": "הרכב לא מניע"}
      ]
    },
    "scenarios": {
      "while_driving": {
        "severity": "critical",
        "description": "...",
        "causes": [
          {
            "id": "alternator_failure",
            "name": "אלטרנטור תקול",
            "probability": 0.7,
            "key_question": {
              "text": "האם שמעת רעש חריקה?",
              "answers": {
                "כן": "confirms",
                "לא": "rules_out"
              }
            }
          }
        ],
        "self_fix_actions": [
          {
            "id": "reduce_power",
            "steps": ["כבה מזגן", "כבה רדיו"],
            "followup_question": {
              "text": "מה המצב?",
              "options": ["הגעתי למוסך", "הרכב כבה"],
              "resolution_paths": { ... }
            }
          }
        ]
      }
    }
  }
}
```

**נורות מוגדרות (דוגמאות):**
- `battery_light` - נורת מצבר
- `oil_pressure_light` - נורת שמן
- `check_engine_light` - נורת ניהול מנוע
- `coolant_temperature_light` - נורת טמפרטורה
- `tpms_light` - נורת לחץ אוויר

---

### 2. `car-symptoms.json` - מיפוי תסמינים
**תפקיד:** מיפוי מילות מפתח לנורות/תרחישים

```json
{
  "symptoms": [
    {
      "category": "warning_lights",
      "mappings": [
        {
          "keywords": ["נורה אדומה", "נורית שמן"],
          "type": "light",
          "targetId": "oil_pressure_light"
        }
      ]
    }
  ]
}
```

---

### 3. `safety-rules.ts` - כללי בטיחות
**תפקיד:** הגדרת מצבי חירום

**רמות:**
| רמה | פעולה |
|-----|-------|
| `CRITICAL` | סיים שיחה מיד, הזמן גרר |
| `WARNING` | הצג אזהרה, המשך בזהירות |

**דוגמאות:**
- בלמים כשלו → CRITICAL
- הגה ננעל → CRITICAL
- עשן מהמנוע → CRITICAL
- ריח דלק → CRITICAL
- נורת שמן → WARNING

---

### 4. `scenarios.ts` - תרחישים סטטיים
**תפקיד:** עצי החלטה קבועים לבעיות כלליות

**דוגמאות:**
- התחממות יתר
- הרכב לא מניע
- רעשים חריגים

---

## API - app/api/ai/questions/route.ts

**תפקיד:** נקודת הכניסה היחידה לצ'אטבוט

**תהליך:**
```
POST /api/ai/questions
        │
        ├── 1. בדיקת בטיחות (analyzeSafetyOnly)
        │       ↳ אם CRITICAL → handleSafetyStop
        │
        ├── 2. אם יש נורה מזוהה (detectedLightType)
        │       ↳ handleKBFlow
        │
        ├── 3. אם יש תרחיש פעיל (currentScenarioId)
        │       ↳ handleScenarioStep
        │
        ├── 4. אם יש תמונה
        │       ↳ callExpertAI (with image)
        │
        ├── 5. ניתוח חדש (analyzeUserContext)
        │       ├── WARNING_LIGHT → handleWarningLightDetection
        │       ├── START_SCENARIO → handleScenarioStart
        │       └── CONSULT_AI → callExpertAI
        │
        └── 6. Fallback → callExpertAI
```

---

## Frontend - app/user/consult/questions/

### 1. `page.tsx` - הדף הראשי
**תפקיד:** קומפוננטת הדף הראשית

**מאפיינים:**
- טעינת נתוני רכב מ-Supabase
- שמירת טיוטה ותמונות
- ניהול הודעות הצ'אט
- שמירת בקשה סופית

---

### 2. `hooks/useHybridFlow.ts` - ה-Hook הראשי
**תפקיד:** ניהול מצב הצ'אטבוט בצד הלקוח

**מצבים:**
```
IDLE → PROCESSING → WAITING_USER → ... → FINISHED
                 ↓
               ERROR
```

**פונקציות:**
- `sendMessage()` - שליחת הודעה ל-API
- `handleAnswer()` - טיפול בתשובת משתמש
- `reset()` - איפוס הצ'אט

---

### 3. `hooks/useAIStateMachine.ts` - State Machine
**תפקיד:** ניהול מצבים מתקדם (משני ל-useHybridFlow)

---

### קומפוננטות UI

| קובץ | תפקיד |
|------|-------|
| `ChatBubble.tsx` | בועת הודעה בודדת |
| `InstructionBubble.tsx` | הוראות לביצוע (צעדים) |
| `FinalDiagnosisCard.tsx` | כרטיס דיאגנוזה סופית |
| `TypingIndicator.tsx` | אינדיקטור "מקליד..." |
| `TypingBubble.tsx` | בועת טיפוגרפיה |
| `YesNoButtons.tsx` | כפתורי כן/לא |
| `MultiChoiceButtons.tsx` | כפתורי בחירה מרובה |
| `FreeTextInput.tsx` | שדה טקסט חופשי |
| `WarningBanner.tsx` | באנר אזהרה |

---

## תרשים זרימה כללי

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND                                        │
│  ┌─────────────┐    ┌──────────────────┐    ┌─────────────────┐              │
│  │ page.tsx    │ → │ useHybridFlow.ts │ → │ Components (UI) │              │
│  └─────────────┘    └──────────────────┘    └─────────────────┘              │
│         │                    │                                               │
│         │         POST /api/ai/questions                                     │
│         ▼                    ▼                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                               API                                            │
│  ┌─────────────────┐                                                         │
│  │ route.ts        │ ← Entry point                                          │
│  └────────┬────────┘                                                         │
│           │                                                                  │
│           ├──────────────────────────────────────────────────────────────┐   │
│           ▼                                                              │   │
│  ┌─────────────────────┐    ┌──────────────────────┐                     │   │
│  │ context-analyzer.ts │ →  │ Routing Decision     │                     │   │
│  └─────────────────────┘    └──────────────────────┘                     │   │
│                                      │                                   │   │
│           ┌──────────────────────────┼──────────────────────────┐        │   │
│           ▼                          ▼                          ▼        │   │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     │   │
│  │ handleKBFlow()  │     │handleScenario() │     │ callExpertAI()  │     │   │
│  └────────┬────────┘     └────────┬────────┘     └────────┬────────┘     │   │
│           │                       │                       │              │   │
│           ▼                       ▼                       ▼              │   │
│  ┌─────────────────────────────────────────────────────────────┐         │   │
│  │                    flow-handlers.ts                         │         │   │
│  │  ┌───────────────────────────────────────────────────────┐  │         │   │
│  │  │                 diagnostic-utils.ts                   │  │         │   │
│  │  │  • determineScenario()                                │  │         │   │
│  │  │  • updateScores()                                     │  │         │   │
│  │  │  • shouldDiagnose()                                   │  │         │   │
│  │  │  • getNextQuestion()                                  │  │         │   │
│  │  │  • generateDiagnosis()                                │  │         │   │
│  │  └───────────────────────────────────────────────────────┘  │         │   │
│  └─────────────────────────────────────────────────────────────┘         │   │
│           │                                                              │   │
│           ▼                                                              │   │
│  ┌─────────────────────────────────────────────────────────────┐         │   │
│  │                    Knowledge Base                           │         │   │
│  │  ┌───────────────────┐  ┌──────────────────┐               │         │   │
│  │  │warning-lights.json│  │ car-symptoms.json│               │         │   │
│  │  │ (168KB, detailed) │  │  (mappings)      │               │         │   │
│  │  └───────────────────┘  └──────────────────┘               │         │   │
│  │  ┌───────────────────┐  ┌──────────────────┐               │         │   │
│  │  │  safety-rules.ts  │  │  scenarios.ts    │               │         │   │
│  │  │   (emergencies)   │  │ (decision trees) │               │         │   │
│  │  └───────────────────┘  └──────────────────┘               │         │   │
│  └─────────────────────────────────────────────────────────────┘         │   │
│           │                                                              │   │
│           ▼                                                              │   │
│  ┌─────────────────────────────────────────────────────────────┐         │   │
│  │                      AI Service                             │         │   │
│  │  ┌─────────────────┐    ┌──────────────────┐               │         │   │
│  │  │    client.ts    │ ←  │ prompt-builder.ts│               │         │   │
│  │  │  (OpenAI GPT)   │    │  (build prompts) │               │         │   │
│  │  └─────────────────┘    └──────────────────┘               │         │   │
│  └─────────────────────────────────────────────────────────────┘         │   │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## נקודות תורפה וחולשות

### 1. 🔴 בעיות קריטיות

#### א. קובץ warning-lights.json גדול מדי (168KB)
**בעיה:** כל הידע בקובץ יחיד ענק
**השפעה:** 
- קשה לתחזק ולערוך
- זמן טעינה ארוך
- סיכון לשגיאות JSON

**פתרון מומלץ:**
```
📁 lib/knowledge/lights/
   ├── battery_light.json
   ├── oil_pressure_light.json
   ├── check_engine_light.json
   └── index.ts (aggregator)
```

---

#### ב. אין מנגנון Caching
**בעיה:** כל קריאה ל-API טוענת את כל ה-KB מחדש
**השפעה:** ביצועים איטיים, עלויות API גבוהות

**פתרון מומלץ:**
- הוספת Redis/Memory cache לתשובות נפוצות
- Pre-compute של שאלות ותשובות

---

#### ג. תלות מוחלטת ב-OpenAI
**בעיה:** אם OpenAI נופל, הכל נופל
**השפעה:** אין fallback

**פתרון מומלץ:**
- הוספת provider נוסף (Claude, Gemini)
- מצב KB-only שלא דורש AI

---

### 2. 🟡 בעיות בינוניות

#### א. לוגיקת ציונים (Scoring) לא מספיק מדויקת
**בעיה:** ציונים מבוססים על probability קבוע
**השפעה:** אבחונים לא מדויקים לפעמים

**פתרון מומלץ:**
- הוספת משקלים דינמיים
- למידה מתשובות קודמות

---

#### ב. אין תמיכה בריבוי שפות אמיתי
**בעיה:** הכל hardcoded בעברית
**השפעה:** קשה להרחיב לשפות אחרות

**פתרון מומלץ:**
- הפרדת טקסטים לקבצי i18n
- תמיכה ב-locale

---

#### ג. חוסר ולידציה בצד הלקוח
**בעיה:** אין בדיקת תקינות לפני שליחה
**השפעה:** בקשות מיותרות ל-API

**פתרון מומלץ:**
- הוספת Zod/Yup validation
- בדיקות בצד הלקוח

---

#### ד. קבצי flow-handlers.ts ו-diagnostic-utils.ts גדולים מדי
**בעיה:** ~1400 ו-~1200 שורות בהתאמה
**השפעה:** קשה לתחזק, לבדוק, ולהבין

**פתרון מומלץ:**
```
📁 lib/ai/handlers/
   ├── kb-flow.ts
   ├── scenario-flow.ts
   ├── resolution-handler.ts
   └── safety-handler.ts

📁 lib/ai/diagnostics/
   ├── scoring.ts
   ├── question-selector.ts
   └── diagnosis-generator.ts
```

---

### 3. 🟢 שיפורים מומלצים

#### א. הוספת Unit Tests
**מצב נוכחי:** אין בדיקות אוטומטיות
**פתרון:** 
- Jest tests לכל פונקציה ב-diagnostic-utils
- Integration tests ל-route.ts

---

#### ב. הוספת Logging & Monitoring
**מצב נוכחי:** רק console.log
**פתרון:**
- הוספת Sentry לשגיאות
- Analytics לזרימות נפוצות
- Dashboard לביצועי AI

---

#### ג. הוספת מנגנון Feedback
**מצב נוכחי:** אין דרך לדעת אם האבחון עזר
**פתרון:**
- כפתורי "עזר/לא עזר"
- טופס משוב בסוף הזרימה
- שמירת נתונים לשיפור עתידי

---

#### ד. תמיכה ב-Offline Mode
**מצב נוכחי:** חייב חיבור אינטרנט
**פתרון:**
- Service Worker עם KB בסיסי
- מצב מצומצם ללא AI

---

## סיכום

המערכת בנויה בצורה מודולרית יחסית עם הפרדה בין:
- **ידע** (knowledge/) - סטטי, ניתן לעדכון
- **לוגיקה** (ai/) - עיבוד ואבחון
- **API** - orchestration
- **UI** - הצגה ואינטראקציה

**החוזקות העיקריות:**
1. בסיס ידע עשיר ומפורט
2. מנגנון בטיחות חזק
3. תמיכה בתמונות
4. זרימה ברורה עם resolution paths

**החולשות העיקריות:**
1. קבצים גדולים מדי
2. אין caching/tests
3. תלות מוחלטת ב-OpenAI
4. קשה לתחזק
