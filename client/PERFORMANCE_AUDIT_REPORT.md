# דוח ביצועים ואופטימיזציה - API Calls

## 🔍 בעיות שזוהו

### 1. ⚠️ כפילות בפונקציות עיבוד תמונות

**בעיה:**
- `app/api/ai/diagnose/route.ts` מכיל פונקציה `fetchImageAsBase64` (שורות 6-41)
- `lib/ai/image-utils.ts` מכיל פונקציה `fetchImageAsInlineData` (שורות 4-26)
- שתי הפונקציות עושות בדיוק את אותו דבר!

**השפעה:**
- קוד כפול = תחזוקה קשה יותר
- סיכון לבעיות עקביות
- גודל קוד מיותר

**פתרון מוצע:**
- למחוק את `fetchImageAsBase64` מ-`diagnose/route.ts`
- להשתמש ב-`fetchImageAsInlineData` מ-`image-utils.ts` בכל המקומות

---

### 2. ⚠️ אין הגבלת גודל תמונות

**בעיה:**
- אין בדיקה על גודל התמונה לפני המרה ל-base64
- ChatGPT API מגביל תמונות ל-20MB (לפני base64 encoding)
- תמונה גדולה = base64 גדול מאוד = עומס על הרשת והשרת

**השפעה:**
- תמונות גדולות יכולות לגרום ל-timeouts
- עלויות גבוהות יותר (יותר tokens)
- זמן תגובה איטי

**פתרון מוצע:**
- להוסיף בדיקת גודל לפני המרה ל-base64
- לדחוס תמונות גדולות (resize/compress)
- להגביל ל-3 תמונות מקסימום (כבר קיים, אבל צריך לוודא)

---

### 3. ⚠️ Prompts ארוכים מאוד

**בעיה:**
- ה-prompt ב-`questions/route.ts` הוא מאוד ארוך (כ-280 שורות!)
- ה-prompt ב-`diagnose/route.ts` גם ארוך מאוד
- כל prompt כולל הרבה הנחיות חוזרות

**השפעה:**
- יותר tokens = יותר עלות
- זמן תגובה איטי יותר
- קשה לתחזק

**פתרון מוצע:**
- לקצר את ה-prompts על ידי הסרת הנחיות חוזרות
- להעביר הנחיות נפוצות ל-system message
- להשתמש ב-prompt templates קצרים יותר

---

### 4. ⚠️ אין אופטימיזציה של תמונות

**בעיה:**
- תמונות נשלחות בגודל מלא ללא דחיסה
- אין resize של תמונות גדולות
- base64 encoding מגדיל את הגודל ב-33%

**השפעה:**
- תמונות גדולות = יותר tokens = יותר עלות
- זמן תגובה איטי
- עומס על הרשת

**פתרון מוצע:**
- להוסיף image compression לפני המרה ל-base64
- להגביל רזולוציה מקסימלית (למשל 1024x1024)
- להשתמש ב-WebP format אם אפשר

---

### 5. ⚠️ אין caching של תמונות

**בעיה:**
- כל פעם ששולחים תמונה, היא נשלפת מחדש מה-URL
- אין caching של תמונות שכבר נשלפו

**השפעה:**
- זמן תגובה איטי יותר
- עומס מיותר על Supabase storage

**פתרון מוצע:**
- להוסיף caching של תמונות (memory cache או Redis)
- לשמור base64 של תמונות שכבר נשלפו

---

### 6. ⚠️ אין הגבלה על מספר תמונות

**בעיה:**
- ב-`questions/route.ts` יש הגבלה ל-3 תמונות (שורה 503)
- ב-`diagnose/route.ts` יש הגבלה ל-3 תמונות (שורה 184)
- אבל אין הגבלה על גודל כל תמונה

**פתרון מוצע:**
- להוסיף הגבלה על גודל כל תמונה (למשל 5MB לפני base64)
- לוודא שהגבלה של 3 תמונות נאכפת בכל המקומות

---

## 📊 הערכת גודל נתונים

### Prompts
- `questions/route.ts`: ~2000-3000 תווים (תלוי בתשובות קודמות)
- `diagnose/route.ts`: ~1500-2500 תווים
- `research/route.ts`: ~500-1000 תווים

### תמונות
- תמונה ממוצעת: ~500KB-2MB (לפני base64)
- base64 encoding: מגדיל ב-33%
- תמונה אחת: ~650KB-2.6MB (אחרי base64)
- 3 תמונות: ~2MB-8MB (אחרי base64)

### סה"כ בקריאה אחת
- עם תמונות: ~2.5MB-11MB
- ללא תמונות: ~2KB-3KB

---

## ✅ המלצות אופטימיזציה

### עדיפות גבוהה:
1. **לאחד פונקציות עיבוד תמונות** - למחוק כפילות
2. **להוסיף הגבלת גודל תמונות** - למנוע תמונות גדולות מדי
3. **לדחוס תמונות** - resize לפני base64

### עדיפות בינונית:
4. **לקצר prompts** - להסיר הנחיות חוזרות
5. **להוסיף caching** - לשמור תמונות שכבר נשלפו

### עדיפות נמוכה:
6. **לשפר error handling** - טיפול טוב יותר בשגיאות תמונות

---

## 🔧 תיקונים מומלצים

### 1. איחוד פונקציות תמונות
```typescript
// למחוק מ-diagnose/route.ts:
async function fetchImageAsBase64(...) { ... }

// להשתמש ב:
import { fetchImageAsInlineData } from "@/lib/ai/image-utils";
```

### 2. הוספת הגבלת גודל
```typescript
// ב-image-utils.ts:
const MAX_IMAGE_SIZE = 5 * 1024 * 1024; // 5MB
if (arrayBuffer.byteLength > MAX_IMAGE_SIZE) {
  throw new Error("Image too large");
}
```

### 3. דחיסת תמונות
```typescript
// להוסיף image compression library
// לדוגמה: sharp או jimp
```

---

## 📈 הערכת שיפור

לאחר התיקונים:
- **גודל תמונות**: ירידה של 50-70% (עם compression)
- **זמן תגובה**: שיפור של 20-30%
- **עלויות**: ירידה של 30-50% (פחות tokens)
- **קוד**: נקי יותר, קל יותר לתחזק

